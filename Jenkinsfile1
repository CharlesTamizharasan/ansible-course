pipeline {
    agent any

    parameters {
        string(name: 'USERNAME_TO_ADD', defaultValue: '', description: 'Enter the username to add to text file')
    }

    environment {
        GITHUB_TOKEN = credentials('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')
        GITHUB_REPO = 'CharlesTamizharasan/ansible-course.git'
        FILE_PATH = 'test'
    }

  stages {
        stage('Debug') {
            steps {
                script {
                    echo "GitHub Token: ${env.GITHUB_TOKEN}"
                    echo "GitHub Repo: ${env.GITHUB_REPO}"
                    echo "File Path: ${env.FILE_PATH}"
                    echo "Username to Add: ${params.USERNAME_TO_ADD}"
                }
            }
        }
        stage('Update GitHub File') {
            steps {
                script {
                    def apiUrl = "https://api.github.com/repos/${env.GITHUB_REPO}/contents/${env.FILE_PATH}"
                    echo "API URL: ${apiUrl}"

                    def existingContent = sh(script: "curl -s -H 'Authorization: token ${env.GITHUB_TOKEN}' ${apiUrl} | jq -r .content | base64 -d", returnStdout: true).trim()
                    echo "Existing Content: ${existingContent}"

                    // Append the new username to the existing content
                    def updatedContent = existingContent + "\n${params.USERNAME_TO_ADD}"
                    echo "Updated Content: ${updatedContent}"


                    // Encode the updated content to base64
                    def encodedContent = updatedContent.bytes.encodeBase64().toString()
                    echo "Encoded Content: ${encodedContent}"

                  // Update the file on GitHub
                    sh """
                        curl -s -X PUT \
                            -H 'Authorization: token ${env.GITHUB_TOKEN}' \
                            -H 'Content-Type: application/json' \
                            -d '''
                                {   
                                "message": "Update text file",
                                "content": "${encodedContent}",
                                "sha": "$(curl -s -H 'Authorization: token ${env.GITHUB_TOKEN}' ${apiUrl} | jq -r .sha)"
                                }
                               '''
                            ${apiUrl}
                    """
                }
            }
        }
    }
}

